<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cTrader DCA cBot å‚æ•°ä¼˜åŒ–è®¡ç®—å™¨</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- ECharts å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
</head>
<body>
    <div id="app">
        <main class="container">
            <div class="input-section">
                <h2>ğŸ›ï¸ cBotå‚æ•°é…ç½®</h2>
                <p class="config-note">ğŸ’¡ åŸºäºæ ‡å‡†åŒ–åˆ†æï¼Œä¸“æ³¨äºDCAç­–ç•¥å‚æ•°ä¼˜åŒ–</p>
                

                <div class="input-group">
                    <label for="pipStep">DCAé—´è· (ç‚¹æ•°)</label>
                    <input 
                        type="number" 
                        id="pipStep"
                        v-model.number="inputParams.pipStep"
                        placeholder="15"
                        min="1"
                        max="1000"
                    >
                </div>

                <div class="input-group">
                    <label for="firstVolume">é¦–æ¬¡ä»“ä½æ‰‹æ•°</label>
                    <input 
                        type="number" 
                        id="firstVolume"
                        v-model.number="inputParams.firstVolume"
                        placeholder="0.01"
                        step="0.01"
                        min="0.01"
                    >
                </div>

                <div class="input-group">
                    <label for="volumeExponent">ä»“ä½å€æ•°æŒ‡æ•°</label>
                    <input 
                        type="number" 
                        id="volumeExponent"
                        v-model.number="inputParams.volumeExponent"
                        placeholder="1.5"
                        step="0.1"
                        min="0.1"
                        max="5.0"
                    >
                </div>

                <div class="input-group">
                    <label for="maxPositions">æœ€å¤§ä»“ä½æ•°</label>
                    <input 
                        type="number" 
                        id="maxPositions"
                        v-model.number="inputParams.maxPositions"
                        placeholder="10"
                        min="1"
                        max="50"
                    >
                </div>

                <div class="input-group">
                    <label for="maxDrawdownPips">é¢„æœŸæœ€å¤§å›æ’¤ (ç‚¹æ•°)</label>
                    <input 
                        type="number" 
                        id="maxDrawdownPips"
                        v-model.number="inputParams.maxDrawdownPips"
                        placeholder="500"
                        min="10"
                        max="10000"
                    >
                </div>

                <div class="input-group">
                    <label for="pipValue">æ¯ç‚¹ä»·å€¼ (USD)</label>
                    <input 
                        type="number" 
                        id="pipValue"
                        v-model.number="inputParams.pipValue"
                        placeholder="1.0"
                        step="0.1"
                        min="0.1"
                        max="100"
                    >
                </div>

                <button class="calculate-btn" @click="calculateDCA" :disabled="isCalculating">
                    {{ isCalculating ? 'è®¡ç®—ä¸­...' : 'ğŸ”¥ åˆ†æé£é™©' }}
                </button>

                <!-- è°ƒè¯•åŠŸèƒ½åˆ‡æ¢ -->
                <button class="debug-toggle-btn" @click="toggleDebugPanel" 
                        :class="{ 'active': showDebugPanel }"
                        title="å¼€å¯è°ƒè¯•é¢æ¿å¯æŸ¥çœ‹è¯¦ç»†è®¡ç®—è¿‡ç¨‹">
                    ğŸ”§ {{ showDebugPanel ? 'å…³é—­' : 'å¼€å¯' }}è°ƒè¯•æ¨¡å¼
                </button>

                <div v-if="errorMessage" class="error-message">
                    âš ï¸ {{ errorMessage }}
                </div>
            </div>

            <div class="result-section">
                <h2>ğŸ“Š åˆ†æç»“æœ</h2>
                
                <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
                <div v-if="calculationResults.totalVolume > 0" class="result-cards">
                    <div class="result-card">
                        <h3>æ€»äº¤æ˜“æ‰‹æ•°</h3>
                        <p class="result-value">{{ formatVolume(calculationResults.totalVolume) }}</p>
                    </div>

                    <div class="result-card risk-card">
                        <h3>æœ€å¤§å¯èƒ½äºæŸ</h3>
                        <p class="result-value loss">{{ formatCurrency(calculationResults.riskMetrics.maxPossibleLoss) }}</p>
                    </div>

                    <div class="result-card">
                        <h3>å›æœ¬æ‰€éœ€ç‚¹æ•°</h3>
                        <p class="result-value">{{ formatPips(calculationResults.riskMetrics.breakEvenPips) }}</p>
                    </div>

                    <div class="result-card">
                        <h3>ä¿è¯é‡‘å ç”¨ (30xæ æ†)</h3>
                        <p class="result-value">{{ formatCurrency(calculationResults.riskMetrics.marginRequired) }}</p>
                    </div>

                    <div class="result-card">
                        <h3>ä»“ä½æ”¾å¤§å€æ•°</h3>
                        <p class="result-value">{{ calculationResults.riskMetrics.positionSizeRisk.toFixed(1) }}x</p>
                    </div>
                </div>

                <!-- é£é™©å»ºè®® -->
                <div v-if="riskAdvice" class="advice-section">
                    <h3>ğŸ’¡ é£é™©å»ºè®®</h3>
                    <div class="advice-content">{{ riskAdvice }}</div>
                </div>

                <!-- ä»“ä½è¯¦æƒ…è¡¨æ ¼ -->
                <div v-if="calculationResults.positions && calculationResults.positions.length > 0" class="positions-table-container">
                    <h3>ğŸ“‹ ä»“ä½æ„å»ºè¯¦æƒ…</h3>
                    <div class="table-responsive">
                        <table class="positions-table">
                            <thead>
                                <tr>
                                    <th>å±‚çº§</th>
                                    <th>å…¥åœºä»·æ ¼</th>
                                    <th>æ‰‹æ•°</th>
                                    <th>è·ç¦»èµ·å§‹ (ç‚¹)</th>
                                    <th>ç´¯è®¡æ‰‹æ•°</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="position in calculationResults.positions" :key="position.level">
                                    <td>{{ position.level }}</td>
                                    <td>{{ formatPrice(position.entryPrice) }}</td>
                                    <td>{{ formatVolume(position.volume) }}</td>
                                    <td>{{ position.pipDistance }}</td>
                                    <td>{{ formatVolume(position.cumulativeVolume) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- è¯¦ç»†åˆ†æå¯¼èˆªåŒºåŸŸ -->
                <div v-if="calculationResults.totalVolume > 0" class="analysis-navigation">
                    <button class="detailed-analysis-btn" @click="toggleDebugPanel" title="æ‰“å¼€è°ƒè¯•é¢æ¿æŸ¥çœ‹è¯¦ç»†å›æ’¤é£é™©åˆ†æå›¾è¡¨">
                        ğŸ“ˆ æŸ¥çœ‹è¯¦ç»†å›æ’¤åˆ†æ
                    </button>
                </div>

                <div v-else class="placeholder">
                    <p>è¾“å…¥cBotå‚æ•°å¹¶ç‚¹å‡»"åˆ†æé£é™©"æŸ¥çœ‹è¯¦ç»†åˆ†æç»“æœ</p>
                </div>
            </div>

        </main>


        <!-- è°ƒè¯•é¢æ¿æ¨¡æ€æ¡† -->
        <div class="debug-modal-overlay" v-if="showDebugPanel" @click="closeOnOverlayClick">
            <div class="debug-modal-content" @click.stop>
                <div class="debug-modal-header">
                    <h2>ğŸ”§ è°ƒè¯•åˆ†æé¢æ¿</h2>
                    <div class="debug-modal-controls">
                        <button class="debug-btn secondary" @click="refreshDebugData" 
                                :disabled="calculationResults.totalVolume === 0"
                                title="åˆ·æ–°è°ƒè¯•æ•°æ®">
                            ğŸ”„ åˆ·æ–°æ•°æ®
                        </button>
                        <button class="debug-btn secondary" @click="exportDebugData" 
                                :disabled="calculationResults.totalVolume === 0"
                                title="å¯¼å‡ºè°ƒè¯•æ•°æ®">
                            ğŸ“Š å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="debug-modal-close" @click="toggleDebugPanel" title="å…³é—­è°ƒè¯•é¢æ¿">
                            âœ•
                        </button>
                    </div>
                </div>
                

                <!-- æ™ºèƒ½ç½‘æ ¼å¸ƒå±€å®¹å™¨ -->
                <div class="debug-grid-container">
                    
                    <!-- å·¦ä¾§ä¸»è¦åŒºåŸŸï¼šå›¾è¡¨åˆ†æ -->
                    <div class="debug-primary-section">
                        <div class="debug-card priority-critical">
                            <div class="card-header collapsible" @click="toggleSection('charts')">
                                <h3>ğŸ“Š å›¾è¡¨åˆ†æ</h3>
                                <span class="toggle-icon" :class="{ 'collapsed': collapsedSections.charts }">â–¼</span>
                            </div>
                            <div class="card-content" v-show="!collapsedSections.charts">
                                <div class="charts-grid">
                                    <!-- ä»“ä½æ„å»ºå›¾è¡¨ -->
                                    <div class="chart-item">
                                        <h4>ä»“ä½æ„å»ºåˆ†æ</h4>
                                        <div id="positionChart" class="chart-container-echarts"></div>
                                    </div>

                                    <!-- å›æ’¤é£é™©å›¾è¡¨ -->
                                    <div class="chart-item">
                                        <h4>å›æ’¤é£é™©æ›²çº¿</h4>
                                        <div id="drawdownChart" class="chart-container-echarts"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§æ¬¡è¦åŒºåŸŸï¼šè®¡ç®—è¯¦æƒ…å’Œæ§åˆ¶ -->
                    <div class="debug-secondary-section">
                        <!-- è®¡ç®—è¿‡ç¨‹ç›‘æ§ -->
                        <div class="debug-card priority-important" v-if="debugInfo.calculationSteps.length > 0">
                            <div class="card-header collapsible" @click="toggleSection('calculation')">
                                <h3>ğŸ“‹ è®¡ç®—è¯¦æƒ…</h3>
                                <span class="toggle-icon" :class="{ 'collapsed': collapsedSections.calculation }">â–¼</span>
                            </div>
                            <div class="card-content" v-show="!collapsedSections.calculation">
                                <div class="debug-summary-compact">
                                    <div class="summary-item">
                                        <span class="label">å‚è€ƒä»·æ ¼:</span>
                                        <span class="value">{{ debugInfo.referencePrice.toFixed(5) }}</span>
                                    </div>
                                    <div class="summary-item" v-if="debugInfo.potentialErrors.length > 0">
                                        <span class="label error">âš ï¸ é—®é¢˜:</span>
                                        <span class="value error">{{ debugInfo.potentialErrors.length }}ä¸ª</span>
                                    </div>
                                </div>
                                
                                <div v-if="debugInfo.potentialErrors.length > 0" class="error-list-compact">
                                    <div v-for="error in debugInfo.potentialErrors" :key="error" class="error-item-compact">
                                        âš ï¸ {{ error }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¿«æ·æ“ä½œé¢æ¿ -->
                        <div class="debug-card priority-optional">
                            <div class="card-header collapsible" @click="toggleSection('actions')">
                                <h3>âš¡ å¿«æ·æ“ä½œ</h3>
                                <span class="toggle-icon" :class="{ 'collapsed': collapsedSections.actions }">â–¼</span>
                            </div>
                            <div class="card-content" v-show="!collapsedSections.actions">
                                <div class="action-buttons-grid">
                                    <button class="action-btn" @click="fullscreenChart('position')" title="ä»“ä½å›¾è¡¨å…¨å±">
                                        ğŸ” ä»“ä½å›¾è¡¨
                                    </button>
                                    <button class="action-btn" @click="fullscreenChart('drawdown')" title="å›æ’¤å›¾è¡¨å…¨å±">
                                        ğŸ” å›æ’¤å›¾è¡¨
                                    </button>
                                    <button class="action-btn" @click="resetChartZoom" title="é‡ç½®å›¾è¡¨ç¼©æ”¾">
                                        ğŸ”„ é‡ç½®ç¼©æ”¾
                                    </button>
                                    <button class="action-btn" @click="toggleChartAnimation" title="åˆ‡æ¢å›¾è¡¨åŠ¨ç”»">
                                        {{ chartAnimationEnabled ? 'â¸ï¸ å…³é—­åŠ¨ç”»' : 'â–¶ï¸ å¼€å¯åŠ¨ç”»' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åº•éƒ¨å…¨å®½åŒºåŸŸï¼šå…¬å¼éªŒè¯ -->
                    <div class="debug-fullwidth-section">
                        <div class="debug-card priority-important" v-if="formulaVerification">
                            <div class="card-header collapsible" @click="toggleSection('verification')">
                                <h3>ğŸ§® å…¬å¼éªŒè¯</h3>
                                <span class="toggle-icon" :class="{ 'collapsed': collapsedSections.verification }">â–¼</span>
                            </div>
                            <div class="card-content" v-show="!collapsedSections.verification">
                                <div class="verification-table-responsive">
                                    <table class="debug-table-improved">
                                        <thead>
                                            <tr>
                                                <th>è®¡ç®—é¡¹ç›®</th>
                                                <th>å…¬å¼</th>
                                                <th>ç»“æœ</th>
                                                <th>çŠ¶æ€</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="item in formulaVerification" :key="item.name">
                                                <td class="item-name">{{ item.name }}</td>
                                                <td class="formula-cell">{{ item.formula }}</td>
                                                <td class="result-cell">{{ item.result }}</td>
                                                <td class="status-cell">
                                                    <span :class="item.status" class="status-badge-improved">
                                                        {{ item.status === 'ok' ? 'âœ… æ­£å¸¸' : 'âš ï¸ å¼‚å¸¸' }}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="js/utils/calculations.js"></script>
    <script src="js/app.js"></script>
</body>
</html>